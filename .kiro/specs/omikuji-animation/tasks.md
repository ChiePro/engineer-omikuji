# Implementation Plan

## Tasks

- [x] 1. アニメーションフェーズ管理フックの実装
- [x] 1.1 useAnimationPhaseフックを作成し、5段階のフェーズ遷移を自動的に制御する機能を実装する
  - アニメーションフェーズ（鳥居通過→参道表示→おみくじ筒振り→棒飛び出し→結果表示）の状態管理
  - 各フェーズの開始時刻と持続時間に基づく自動遷移
  - フェーズ変更時のコールバック呼び出し
  - 完了時のコールバック呼び出し
  - reduced-motion設定時の即座完了への対応
  - ステータスメッセージインデックスの段階的更新
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 6.3_

- [x] 2. 視覚的要素のサブコンポーネント実装
- [x] 2.1 (P) 鳥居通過アニメーションコンポーネントを作成し、3D遠近法で鳥居を奥から手前へ通過する演出を実装する
  - CSS transform（perspective + translateZ + scale）を使用した3D表現
  - 約1秒のアニメーション時間
  - 大凶時の暗いスタイル対応（isDaikyoプロパティ）
  - デザインシステムのtoriiトークンを活用したスタイリング
  - 完了時のコールバック呼び出し
  - _Requirements: 1.1, 2.1_

- [x] 2.2 (P) 参道背景コンポーネントを作成し、神社の参道・石畳・石灯籠・注連縄を表示する
  - rotateXによる参道の奥行き感表現
  - 石畳のパターン表示
  - 左右に配置した石灯籠とflickerアニメーションによる灯火表現
  - 画面上部の注連縄表示とゆらぎアニメーション
  - 大凶時の暗いスタイル対応
  - _Requirements: 1.2, 2.2, 2.3, 2.4_

- [x] 2.3 (P) 桜の花びらエフェクトコンポーネントを作成し、舞い落ちる花びらを表示する
  - ランダムな位置・サイズ・速度での花びら生成（15〜40個）
  - 回転しながら落下するアニメーション
  - 大吉時の花びら増量対応
  - パフォーマンス最適化（GPU加速プロパティ使用）
  - _Requirements: 2.5, 4.2_

- [x] 2.4 (P) おみくじ筒コンポーネントを作成し、振りアニメーションを実装する
  - 赤いおみくじ筒の表示（朱色ベース）
  - rotate + translateYによる振りモーション
  - 約1.5秒、4回の振りサイクル
  - 大凶時の暗いスタイル対応
  - 完了時のコールバック呼び出し
  - _Requirements: 1.3, 2.6_

- [x] 2.5 (P) おみくじ棒コンポーネントを作成し、飛び出しアニメーションと運勢表示を実装する
  - 木製おみくじ棒の表示
  - translateY + rotateによる飛び出しアニメーション
  - 運勢テキストの縦書き表示（writing-mode: vertical-rl）
  - 大凶時の暗いスタイル対応
  - _Requirements: 1.4, 1.5, 2.7_

- [x] 3. エンジニア要素の演出コンポーネント実装
- [x] 3.1 (P) コードログストリームコンポーネントを作成し、背景にエンジニア風コードをストリーム表示する
  - エンジニア風コードログの定義（git commit、npm install等）
  - ランダムな位置とタイミングでの表示
  - 上から下へ流れるストリームアニメーション
  - 大凶時の赤いスタイル対応
  - モノスペースフォントの適用
  - _Requirements: 3.1_

- [x] 3.2 (P) ステータスメッセージコンポーネントを作成し、おみくじ種類に応じた動的なタイトルとメッセージを表示する
  - おみくじ種類とタイトルのマッピング定義（5種類対応）
  - デフォルトステータスメッセージの定義
  - メッセージの段階的な更新表示
  - カスタムメッセージ配列の受け取り対応
  - 大吉時の金色スタイル、大凶時の赤いスタイル対応
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 4. 運勢別特別演出コンポーネントの実装
- [x] 4.1 特別演出コンポーネントを作成し、運勢に応じた視覚効果を表示する
  - 運勢値に基づく演出タイプの判定（大吉/大凶/通常）
  - 大吉時の虹色後光オーラエフェクト（conic-gradient回転）
  - 大凶時の背景暗転（赤/黒グラデーション）
  - 大凶時の微振動エフェクト（transform: translate）
  - 大凶時の闇の霧オーバーレイ
  - 効果のフェードイン/フェードアウト
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5. メインアニメーションコンポーネントの実装
- [x] 5.1 OmikujiAnimationコンポーネントを作成し、すべてのサブコンポーネントを統合する
  - useAnimationPhaseフックを使用したフェーズ管理
  - 各サブコンポーネントへの適切なprops配布
  - フェーズに応じたサブコンポーネントの表示/非表示制御
  - アニメーション完了時のonCompleteコールバック呼び出し
  - reduced-motion検出とフォールバック表示
  - props検証とデフォルト値設定
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5.2 パフォーマンス最適化を実装し、60fpsのスムーズなアニメーションを確保する
  - GPU加速プロパティ（transform, opacity）のみを使用
  - will-changeの適切な設定と解除
  - React.memoによる不要な再レンダリング防止
  - パーティクル数の制限（桜の花びら等）
  - _Requirements: 6.1, 6.2_

- [x] 5.3 アクセシビリティ対応を実装し、すべてのユーザーが快適に利用できるようにする
  - reduced-motion設定の検出と簡略化アニメーションへの切り替え
  - aria-live領域でのステータス通知
  - スクリーンリーダー向けの代替テキスト
  - _Requirements: 6.3, 6.4_

- [x] 5.4 レスポンシブ対応を実装し、モバイルデバイスでも適切に表示されるようにする
  - ビューポートサイズに応じたレイアウト調整
  - タッチデバイス向けの最適化
  - 小さい画面でのパーティクル数削減
  - _Requirements: 6.5_

- [x] 6. 既存システムとの統合
- [x] 6.1 OmikujiFlowコンポーネントを修正し、OmikujiAnimationを統合する
  - loading状態でOmikujiLoadingIndicatorからOmikujiAnimationへの切り替え
  - API結果のキャッシュとアニメーション完了後の表示
  - fortune, omikujiTypeのprops受け渡し
  - onCompleteコールバックでのflowState遷移
  - 既存のAnimatePresenceとの連携
  - _Requirements: 7.1_

- [x] 7. テストの実装
- [x] 7.1 useAnimationPhaseフックのユニットテストを作成する
  - フェーズ遷移のタイミング検証
  - コールバック呼び出しの検証
  - reduced-motion時の動作検証
  - restart機能の検証
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 7.2 (P) OmikujiAnimationコンポーネントのテストを作成する
  - propsに応じた正しいサブコンポーネント表示の検証
  - onComplete呼び出しの検証
  - アクセシビリティ属性の検証
  - _Requirements: 5.1, 5.2, 5.3, 6.4_

- [x] 7.3 (P) StatusMessageコンポーネントのテストを作成する
  - おみくじ種類に応じたタイトル表示の検証
  - メッセージ更新の検証
  - スタイル適用の検証
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.4 (P) SpecialEffectsコンポーネントのテストを作成する
  - 大吉時の演出表示検証（fortune.value >= 6）
  - 大凶時の演出表示検証（fortune.value <= 1）
  - 通常時の非表示検証
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7.5 OmikujiFlowとの統合テストを作成する
  - loading状態でのOmikujiAnimation表示検証
  - アニメーション完了後のflowState遷移検証
  - API結果とアニメーションの連携検証
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
